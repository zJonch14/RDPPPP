name: RDP with Ngrok

on:
  workflow_dispatch:  # Permite ejecución manual
  # Para ejecución automática en push (opcional):
  # push:
  #   branches: [ main ]

jobs:
  setup-rdp:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Ngrok
      run: |
        # Descargar y configurar Ngrok
        Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile ngrok.zip
        Expand-Archive ngrok.zip
        .\ngrok\ngrok.exe authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        
    - name: Configure Windows Remote Desktop
      run: |
        # Habilitar RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        # Configurar credenciales (cambia 'user' y 'pass' por tus valores)
        $username = "Administrator"
        $password = "P@ssw0rd123!"  # Cambia esta contraseña
        
        # Crear usuario si no existe (opcional)
        $userExists = Get-LocalUser -Name $username -ErrorAction SilentlyContinue
        if (-not $userExists) {
          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name $username -Password $securePassword
          Add-LocalGroupMember -Group "Administrators" -Member $username
        }
        
        # Habilitar cuenta
        Enable-LocalUser -Name $username
        
        # Mostrar información
        Write-Host "Usuario: $username"
        Write-Host "Contraseña: $password"
        
    - name: Start Ngrok tunnel for RDP
      run: |
        # Iniciar túnel Ngrok para RDP (puerto 3389)
        Start-Process -FilePath ".\ngrok\ngrok.exe" -ArgumentList "tcp 3389" -NoNewWindow
        
        # Esperar a que Ngrok se inicie
        Start-Sleep -Seconds 5
        
        # Obtener URL pública del túnel
        $tunnelInfo = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels"
        $publicUrl = $tunnelInfo.tunnels[0].public_url
        
        # Mostrar información de conexión
        Write-Host "========================================="
        Write-Host "RDP CONNECTION INFO:"
        Write-Host "Public URL: $publicUrl"
        Write-Host "Username: Administrator"
        Write-Host "Password: P@ssw0rd123!"  # Usa la misma contraseña del paso anterior
        Write-Host "========================================="
        
        # Mantener el workflow activo (60 minutos máximo)
        Write-Host "RDP session will be available for 60 minutes..."
        Start-Sleep -Seconds 3540  # 59 minutos
